var AWS = require('aws-sdk');
var easyinvoice = require('easyinvoice');
const { v4: uuidv4 } = require('uuid');
//var fs = require('fs');
AWS.config.update({
    accessKeyId: "ASIAZSJWKMQSPB44GBPR",
    secretAccessKey: "qHG+pLiGVMly4HiOQYk1D0xLQL/TNBhorugBMrHn",
    sessionToken: "FwoGZXIvYXdzEHUaDJQtlwh27kWnbOFjQCLAATe14DOvFqvy5vSzYJ53zsnWXvCErxWVT5kHHlHAQSsfSnLBjMfPYoA6fsGvNIHVc0v138c6HNlWRM/hTa1Z986VR9zY3gfT3Lkp8wPihvC3Z1/g5QATtJjjS/MeEGawcGTNbp4eqtfCnDzzwMSBYizbE1RZs6wIRp5ppesgOr2yDiL2eQVy+ZTchecsqnmDs75fpvD4OwBWotUlo53XSGkbhN368iJLZ/2eeOP25pmYBpxBxFNb8I6KNJ/izBMRvCjdssOWBjItEYaxg+6ongBiMCyLzBaY/VqMc2lGx/EJSzeAfX2YmWlOT3Qg/xl0N3zg18hG"
  });

// Create the DynamoDB service object
var ddb = new AWS.DynamoDB({
    region: 'us-east-1',
    apiVersion: '2012-08-10'
});
var s3 = new AWS.S3({
    params: {
        Bucket: 'invoices-dalsoft5410'
    }
});

//function to create file in bucket
async function createFile(data) {
    return new Promise(function(resolve, reject) {
        s3.putObject(data, function(err, data) {
            if (err) {
                console.log(err);
                resolve(false);
            } else {
                resolve(true);

            }
        });
    });
}
async function generateInvoice(orderItems,orderPlaceBy,invoiceNumber){
    console.log("orderItems"+JSON.stringify(orderItems));
    var taxrate = 15; 
    var orderitem ="[";
    for(let i=0;i<orderItems.length;i++){
        orderitem = orderitem + '{"quantity":"'+orderItems[i].quantity+'","description":"'+orderItems[i].name+'","tax-rate":"'+taxrate+'","price":"'+orderItems[i].price+'"},';
    }
    orderitem = orderitem.slice(0,-1);
    orderitem = orderitem+"]";
    console.log("orderietm"+orderitem);
    
    var orderItems = "";
    var emailId = orderPlaceBy;
    var firstName = "Manali";
    var lastName = "Shah";
    var data = {
        "client": {
         "company": emailId,
         "zip": lastName,
          "city": firstName
     },
         "sender": {
             "company": "DALSoft5410",
             "address": "Goldberg Computer Science Building",
             "zip": "B3H 1W5",
             "city": "Halifax",
             "country": "Canada"
         },
         "information": {
             "number": invoiceNumber,
             "date": new Date().toISOString().slice(0, 10)
         },
     
         "products": JSON.parse(orderitem),
     
         "settings": {
             "currency": "CAD",
         },
     };
     
     easyinvoice.createInvoice(data, function (result) {
        (async () => {
         var pdfBuffer = Buffer.from(result.pdf, 'base64')
             var data = {
                 Key: invoiceNumber,
                 Body: pdfBuffer,
                 ContentEncoding: 'base64',
                 ContentType: 'application/pdf'
             };
         await createFile(data);
     })();
       
     });

}

//reference taken from - https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_UpdateItem.html
//function to put item to DynamoDB 
async function putItemToDB(putparams) {
    return new Promise(function(resolve, reject) {
        ddb.putItem(putparams, function(err, data) {
            if (err) {
                //resolve true if the condition expression fail
                console.log(err);
                resolve(false);
            } else {
                console.log(data);
                //resolve false if item is successfully added to DynamoDB
                resolve(true);
            }
        })
    });
}
exports.placeOrder = (req, res) => {
  var now = new Date();
var orderId = uuidv4();
var invoiceNumber=orderId.split('-')[0];
var isSuccess = false;
var params = {
    TableName: 'orders',
    Item: {
        'id': {
            S: orderId
        },
        'order': {
            S: JSON.stringify(req.body.orderItems)
        },
        'orderPlacesTime': {
            S: now.toISOString()
        },
        'orderReadyTime': {
            S: ''
        },
        'orderDeliveredTime': {
            S: ''
        },
        'orderCurrentStatus': {
            S: 'Order Placed'
        },
        'orderPlacedBy': {
            S: req.body.orderPlaceBy
        },
        'total': {
            S: String(req.body.total)
        },
        'invoiceNumber' :{
            S: invoiceNumber
        }
    }
};

(async () => {
    isSuccess = await putItemToDB(params); //put item to DynamoDB with updated frequency value 
    await generateInvoice(req.body.orderItems,req.body.orderPlaceBy,invoiceNumber);
    if(isSuccess) {
res.status(200).send(JSON.parse("{\"response\":\"Order Placed Successfully!\"}"));
} else {
    res.status(400).send(JSON.parse("{\"response\":\"There was some error while placing the order. Please try again after sometime.\"}"));
}
})();
};
